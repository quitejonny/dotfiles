#!/usr/bin/env bash
set -e

command_completion() {
        cat << 'ALIASES'
_system-bootstrap-completion() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    local prev=${COMP_WORDS[COMP_CWORD-1]}
    case ${COMP_CWORD} in
        1)
            COMPREPLY=($(compgen -W "--help run completion backup restore-backup" -- $cur))
            ;;
    esac
}

complete -F _system-bootstrap-completion system-bootstrap
ALIASES
}

system-bootstrap() {
    local base_path="$(cd "$(dirname "$0")/.." && pwd)"

    usage() {
        cat << USAGE
Usage:
  system-bootstrap [command]

Available Commands:
  run             installs system packages, configures the system and links dotfiles
  completion      prints bash completion for this command
  backup          runs restic backup
  restore-backup  restores restic backup

Flags:
  -h, --help     shows this help message
USAGE
    }

    while [[ "$1" == * ]] ; do
        case "$1" in
            -h | --help )
                usage
                return
                ;;
            -- )
                shift
                break
                ;;
            -* )
                echo "failed parsing option '$1'" >&2
                return
                ;;
            * )
                break
                ;;
        esac
        shift
    done

    local subcommand=$1
    if [ $# -gt 0 ]; then
        shift
    fi

    case "$subcommand" in
        run )
            bash "$base_path/share/system-bootstrap/run" "$@"
            ;;
        completion )
            command_completion
            ;;
        backup )
            restic backup "$HOME/Documents/" "$HOME/Music/" "$HOME/Pictures/"
            ;;
        restore-backup )
            bash "$base_path/share/system-bootstrap/backup-restore" "$@"
            ;;
        * )
            echo "Unknown command '$subcommand'" >&2
            return
            ;;
    esac

}

system-bootstrap "$@"
